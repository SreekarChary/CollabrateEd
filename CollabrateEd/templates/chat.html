{% extends "base.html" %}
{% block content %}

<h4 class="mb-4">Chat for {{ project.name }}</h4>

<form id="chatForm" method="POST" class="input-group mb-3 w-75"
      data-sender-id="{{ session['user_id'] }}"
      data-project-id="{{ project.id }}">
  <input id="chatInput" name="text" class="form-control" placeholder="Type a message" required>
  <button type="submit" class="btn btn-primary">Send</button>
</form>

<div class="chat-box border rounded p-3 bg-light" id="chatMessages">
  {% for msg in messages %}
    {% set color = user_colors[msg.sender_id] %}
    <div class="mb-2">
      <strong class="{{ color }}">{{ msg.sender.username }}:</strong> {{ msg.text }}
    </div>
  {% endfor %}
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();

  const chatForm = document.getElementById('chatForm');
  const senderId = chatForm.dataset.senderId;
  const projectId = chatForm.dataset.projectId;

  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const text = document.getElementById('chatInput').value;
    socket.emit('send_message', {
      sender_id: parseInt(senderId),
      project_id: parseInt(projectId),
      text: text
    });
    document.getElementById('chatInput').value = '';
  });

  socket.on('new_message', function(data) {
    const chatBox = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'mb-2';
    // ðŸŒŸ FIX: Use username and color_class from the server
    div.innerHTML = `<strong class="${data.color_class}">${data.username}:</strong> ${data.text}`;
    chatBox.prepend(div);
  });
</script>

{% endblock %}