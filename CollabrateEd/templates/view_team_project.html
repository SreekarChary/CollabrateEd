{% extends "base.html" %}
{% block content %}

<h4 class="mb-4">{{ project.name }} - Team Project Details</h4>

<ul class="nav nav-tabs mb-4" id="teamProjectTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab" aria-controls="tasks" aria-selected="true">Tasks</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" role="tab" aria-controls="chat" aria-selected="false">Chat</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab" aria-controls="files" aria-selected="false">Files</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="team-tab" data-bs-toggle="tab" data-bs-target="#team" type="button" role="tab" aria-controls="team" aria-selected="false">Team Members & Invite</button>
  </li>
</ul>

<div class="tab-content" id="teamProjectTabsContent">
  
  <div class="tab-pane fade show active" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
    <div class="card p-4 mb-4">
      <h5 class="card-title">Add New Task</h5>
      <form method="POST" action="{{ url_for('add_task', project_id=project.id) }}" class="input-group mb-4">
        <input type="text" name="title" placeholder="Task title" class="form-control" required>
        <input type="date" name="due_date" class="form-control w-25">
        <button type="submit" class="btn btn-primary">Add Task</button>
      </form>
    </div>

    <div class="card p-4">
      <h5 class="card-title mb-3">Project Tasks</h5>
      <ul class="list-group list-group-flush" id="taskList">
        {% for task in tasks %}
          <li class="list-group-item d-flex justify-content-between align-items-start flex-column" data-task-id="{{ task.id }}">
            <div class="w-100 d-flex justify-content-between align-items-start">
              <div class="me-auto">
                <strong>{{ task.title }}</strong>
                <small class="d-block text-muted">Assigned: {{ task.assignee.username if task.assignee else 'Unassigned' }}</small>
              </div>
              <div>
                {% if task.due_date %}
                  <span class="badge bg-warning text-dark ms-2">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</span>
                {% endif %}
                {% if task.submitted %}
                  <span class="badge bg-success ms-2 task-status-badge">
                    Submitted by {{ task.submitter_user.username }} on {{ task.submitted_at.strftime('%Y-%m-%d') }}
                  </span>
                {% else %}
                  <span class="badge bg-danger ms-2 task-status-badge">Not Submitted</span>
                {% endif %}
              </div>
            </div>
            {% if not task.submitted %}
              <form method="POST" action="/submit-task/{{ task.id }}" class="mt-2 task-submission-form">
                <button class="btn btn-outline-success btn-sm">Mark as Submitted</button>
              </form>
            {% endif %}
          </li>
        {% else %}
          <li class="list-group-item text-muted text-center">No tasks yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  
  <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
    <div class="card p-4">
      <h5 class="card-title mb-3">Team Chat</h5>
      
      <form id="chatForm" method="POST" class="input-group mb-3"
            data-sender-id="{{ session['user_id'] }}"
            data-project-id="{{ project.id }}">
        <input id="chatInput" name="text" class="form-control" placeholder="Type a message" required>
        <button type="submit" class="btn btn-primary">Send</button>
      </form>

      <div class="chat-box border rounded p-3 bg-light" id="chatMessages" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column-reverse;">
        {% for msg in messages %}
          {% set color = user_colors[msg.sender_id] %}
          <div class="mb-2">
            <strong class="{{ color }}">{{ msg.sender.username }}:</strong> {{ msg.text }}
            <small class="text-muted float-end">{{ msg.timestamp.strftime('%H:%M') }}</small>
          </div>
        {% else %}
            <p class="text-muted text-center mt-5">No messages yet.</p>
        {% endfor %}
      </div>
      
    </div>
  </div>

  <div class="tab-pane fade" id="files" role="tabpanel" aria-labelledby="files-tab">
    <div class="card p-4">
      <h5 class="card-title mb-3">Upload Shared Notes</h5>
      <form method="POST" action="{{ url_for('upload_team_note', project_id=project.id) }}" enctype="multipart/form-data" class="mb-4">
        <label class="form-label">ðŸ“Ž Add your files here (PDF/DOC)</label>
        <div class="input-group">
          <input type="file" name="file" class="form-control" required>
          <button class="btn btn-outline-secondary" type="submit">Upload</button>
        </div>
      </form>

      <h5 class="card-title mb-3">Shared Notes</h5>
      <ul class="list-group list-group-flush">
        {% for note in notes %}
          <li class="list-group-item">
            <a href="{{ url_for('uploaded_file', filename=note.filename) }}" target="_blank">{{ note.filename }}</a>
          </li>
        {% else %}
          <li class="list-group-item text-muted">No notes uploaded yet.</li>
        {% endfor %}
      </ul>
    </div>
  </div>
  
  <div class="tab-pane fade" id="team" role="tabpanel" aria-labelledby="team-tab">
    <div class="card p-4">
      <h5 class="card-title mb-3">Team Members ({{ members | length }})</h5>
      <ul class="list-group mb-4 list-group-flush">
        {% for member in members %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ member.username }}
            {% if member.id == project.owner_id %}
                <span class="badge bg-primary">Owner</span>
            {% else %}
                <span class="badge bg-secondary">Member</span>
            {% endif %}
          </li>
        {% else %}
          <li class="list-group-item text-muted">No members yet.</li>
        {% endfor %}
      </ul>

      <h5 class="card-title mb-3">Invite More Members</h5>
      <form method="POST" action="{{ url_for('invite_member', project_id=project.id) }}" class="input-group mb-4">
        <select name="username" class="form-select" required>
          {% for user in all_users %}
            <option value="{{ user.username }}">{{ user.username }}</option>
          {% else %}
            <option value="" disabled>No users to invite</option>
          {% endfor %}
        </select>
        <button class="btn btn-primary">Invite</button>
      </form>
    </div>
  </div>
  
</div>

<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  const chatMessages = document.getElementById('chatMessages');
  const chatForm = document.getElementById('chatForm');
  const senderId = chatForm ? chatForm.dataset.senderId : null;
  const projectId = chatForm ? chatForm.dataset.projectId : null;
  
  // --- Live Chat Logic (Only runs if the Chat form/tab exists) ---
  if (chatForm) {
      chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const text = document.getElementById('chatInput').value;
        if (text.trim()) {
            socket.emit('send_message', {
              sender_id: parseInt(senderId),
              project_id: parseInt(projectId),
              text: text
            });
            document.getElementById('chatInput').value = '';
        }
      });
  }

  socket.on('new_message', function(data) {
    if (data.project_id == projectId) {
        const div = document.createElement('div');
        div.className = 'mb-2';
        // Note: The data.timestamp is formatted as HH:MM by the server
        div.innerHTML = `<strong class="${data.color_class}">${data.username}:</strong> ${data.text} <small class="text-muted float-end">${data.timestamp}</small>`;
        // Prepend new message to the top of the reversed chat box
        chatMessages.prepend(div);
    }
  });

  // --- Live Task Update Logic (for submitted tasks) ---
  socket.on('task_submitted', function(data) {
    if (data.project_id == projectId) {
        const taskItem = document.querySelector(`li[data-task-id="${data.task_id}"]`);
        if (taskItem) {
            // 1. Remove the submission form
            const form = taskItem.querySelector('.task-submission-form');
            if (form) {
                form.remove();
            }
            
            // 2. Update the badge/status
            const badgeContainer = taskItem.querySelector('.task-status-badge');
            if (badgeContainer) {
                badgeContainer.className = 'badge bg-success ms-2 task-status-badge';
                badgeContainer.innerHTML = `Submitted by ${data.submitter_username} on ${data.submitted_at_date}`;
            }
        }
    }
  });

  // --- Keep the current tab active on page refresh/redirect ---
  const triggerTabList = document.querySelectorAll('#teamProjectTabs button')
  const tabs = Array.from(triggerTabList).map(triggerEl => new bootstrap.Tab(triggerEl));

  triggerTabList.forEach(triggerEl => {
    triggerEl.addEventListener('click', event => {
      // Store the active tab hash in the URL
      history.pushState(null, '', event.currentTarget.dataset.bsTarget);
    });
  });
  
  // Activate tab from URL hash on load
  const hash = window.location.hash;
  if (hash) {
      const activeTab = document.querySelector(`#teamProjectTabs button[data-bs-target="${hash}"]`);
      if(activeTab) {
          bootstrap.Tab.getInstance(activeTab).show();
      }
  }

</script>

{% endblock %}